(function (d) {
  //Initial object preparation & message events
  var pp = window.presspatron;
  var host_url = "http://dashboard.presspatron.com";
  if(pp == null){
    pp = window.presspatron = {};
    pp.receiveMessage = handleIframeMessages;
    window.addEventListener("message", pp.receiveMessage, false);
  }

  function handleIframeMessages(event){
      if (extractDomain(event.origin) !== extractDomain(host_url)){
        return;
      }
      else{
        switch (event.data) {
          case "modal":
            var modal = d.getElementById("pp-modal");
            if(modal == null) {
              setupDonationModal();
              document.documentElement.classList.add("pp-modal-open");
            }
            else{
              document.documentElement.classList.remove("pp-modal-open");
              tearDownDonationModal();
            }
            break;
          case "updateBanner":
            var bannerFrame = document.querySelector("iframe[name=banner-frame]");
            bannerFrame.contentWindow.postMessage("update",host_url);
            break;
          case "hide":
            var banner = document.getElementById("pp-banner");
            if(banner) {
              banner.style.display = "none";
              setHideCookie();
            }
          default:
            return;
        }
      }
  }

  function setHideCookie() {
      var date = new Date(),
          days = 7;
      date.setTime(date.getTime() + (days*24*60*60*1000));
      var expires = "expires="+ date.toUTCString();
      document.cookie = "_presspatron-hide_banner=true;" + expires + ";path=/";
  }

  function checkHideCookie() {
    var value = "; " + document.cookie;
    var parts = value.split("; " + "_presspatron-hide_banner" + "=");
    return (parts.length >= 2);
  }

  function createStyles() {
    var styles = document.createElement("style");
    styles.id = "pp-styles";
    styles.innerText = "html.pp-modal-open,.pp-modal-open body {overflow:hidden;}"
    document.body.appendChild(styles);
  };

  function setupComponents() {
    //create the required styles
    createStyles();
    //banner iframe setup
    var banner, bannerCont = d.getElementById("pp-banner");
    if(bannerCont && !(checkHideCookie())){

      banner = d.createElement("iframe");
      banner.className = "pp-banner-cont";
      banner.src = "//dashboard.presspatron.com/websites/13";
      banner.frameborder="0";
      banner.scrolling = "no";
      banner.name = "banner-frame";
      s = banner.style
      var elStyle = banner.style;
      elStyle.width = "100%"; elStyle.height = "44px"; elStyle.display = "block";
      elStyle.border = "none";
      bannerCont.appendChild(banner);
    }

    //button iframe setup
    var button, buttonCont = d.getElementById("pp-donate-button");
    if(buttonCont){
      button = d.createElement("iframe"), bStyle = button.style;;
      button.name = button.id = "button-frame";
      button.frameborder = "0";
      button.scrolling = "no";
      button.allowtransparency="true";
      bStyle.width = "180px"; bStyle.height="34px"; bStyle.border="none";
      button.src = "//dashboard.presspatron.com/websites/13/get_button";
      buttonCont.appendChild(button);
    }
  }

  function setupDonationModal() {
    //Basic iframe modal setup
    var modal = d.createElement("iframe"), s = modal.style;
    modal.name = "donation-frame";
    modal.src = "//dashboard.presspatron.com/donations/new?frame=1&t=4bb1TSXiARU2H3G6EYwyqfPx";
    s.width="100%";s.height="100%";s.position="fixed";s.zIndex=9999;s.top=0;s.left=0;
    s.border="none";
    modal.allowtransparency="true";
    modal.scrolling = "no";
    modal.id = "pp-modal";
    d.body.appendChild(modal);
  }

  function tearDownDonationModal() {
    var donationFrame = document.querySelector("iframe[name=donation-frame]");
    d.body.removeChild(donationFrame)
  }

  function extractDomain(url) {
    urlParts = url.match(/^https?:\/\/(.*)$/);
    return urlParts.length >= 1 ? urlParts[1] : null;
  }

  // if both divs are ready, ELSE if the whole DOM is ready, ELSE wait until DOM loads
  // the first check is for speed, the second catches this script loading after DOM,
  // the final catches everything else
  if(document.querySelectorAll("#pp-banner, #pp-donate-button").length === 2){
    setupComponents();
  }
  else if (document.readyState.match(/^(ready|loaded|interactive|complete)$/)) {
    setupComponents();
  } else {
    document.addEventListener('DOMContentLoaded', function () {
      setupComponents();
    });
  }
}(document));
